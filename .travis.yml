sudo: false
language: rust
cache: cargo
matrix:
    allow_failures:
        - os: windows
    include:
        - os: linux
          dist: xenial
          env: LLVM_VERSION=9.0.0
          rust: beta
          addons:
              apt:
                  sources:
                      - ubuntu-toolchain-r-test
        - os: osx
          osx_image: xcode9.4
          rust: stable
        - os: windows
          rust: stable
before_script:
    - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
          export TRAVIS_OS_NAME=macOS;
      fi
    - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
          export LLVM=clang+llvm-${LLVM_VERSION}-x86_64-linux-gnu-ubuntu-16.04;
          wget http://llvm.org/releases/${LLVM_VERSION}/${LLVM}.tar.xz;
          mkdir llvm;
          tar -xf ${LLVM}.tar.xz -C llvm --strip-components=1;
          export LIBCLANG_PATH=`pwd`/llvm/lib/;
      fi
    - if [[ "$TRAVIS_OS_NAME" != "windows" ]]; then
          wget -O ispc.tar.gz https://downloads.sourceforge.net/project/ispcmirror/v1.12.0/ispc-v1.12.0-${TRAVIS_OS_NAME}.tar.gz;
          tar -xvf ispc.tar.gz;
      else
          wget -O LLVM-9.0.0 https://www.dl.dropboxusercontent.com/s/qrfmt0uqkyn1dz2/LLVM-9.0.0.7z;
          7z x LLVM-9.0.0.7z -y;
          export PATH=$PATH:`pwd`/LLVM-9.0.0/;
          export LIBCLANG_PATH=`pwd`/LLVM-9.0.0/;
          wget -O ispc.zip https://downloads.sourceforge.net/project/ispcmirror/v1.12.0/ispc-v1.12.0-${TRAVIS_OS_NAME}.zip;
          7z x ispc.zip -y;
      fi
    - export PATH=$PATH:`pwd`/ispc-v1.12.0-linux/bin/:`pwd`/ispc-v1.12.0-macOS/bin/:`pwd`/ispc-v1.12.0-windows/bin
    - ispc --version
    - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
          pip install 'travis-cargo<0.2' --user;
          export PATH=$HOME/.local/bin:$PATH;
      fi
    - if [[ "$TRAVIS_OS_NAME" == "macOS" ]]; then export TRAVIS_OS_NAME=osx; fi
    - rustup component add clippy
script:
    - cargo build
    - cargo test
    - cargo clippy
    - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then cargo doc; fi
    - for d in `ls examples/`; do
          cd examples/${d}/;
          pwd;
          if [[ "$d" == "simple" ]]; then
            cargo build --features ispc;
          fi;
          cargo build;
          if [[ "$?" != "0" ]]; then exit 1; fi;
          cd ../../;
      done
after_success:
    - git config user.name "Travis-CI Doc Bot"
    - git config user.email "willusher.life@gmail.com"
    - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then travis-cargo --only stable doc-upload; fi

